name: "Custom CodeQL bundles"

on:
  pull_request:
    paths:
      - "customizations/**"
      - "bundles.json"
    branches:
      - main
  workflow_dispatch:

jobs:
  prepare-bundles-matrix:
    name: "Prepare CodeQL bundle matrix"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.export-bundle-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Export CodeQL bundle matrix
        id: export-bundle-matrix
        run: |
          echo "::set-output name=matrix::$(
            jq --compact-output . bundles.json
          )"

  build-bundles:
    name: "Build custom CodeQL bundles"
    needs: prepare-bundles-matrix
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.prepare-bundles-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: "Build custom CodeQL bundle"
        env:
          CODEQL_BUNDLE: ${{ matrix.bundle }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release --repo github/codeql-action download -p codeql-bundle.tar.gz $CODEQL_BUNDLE

          tar xf codeql-bundle.tar.gz
          rm codeql-bundle.tar.gz

          for lang_path in customizations/*; do
            # Copy custom modules
            lang=${lang_path##*/}
            mkdir codeql/qlpacks/codeql-$lang-lib/customizations
            cp $lang_path/*.qll codeql/qlpacks/codeql-$lang-lib/customizations

            # Import custom modules
            for module_path in $lang_path/*.qll; do
              module_file=${module_path##*/}
              module_name=${module_file%.*}
              echo "import customizations.$module_name" >> codeql/qlpacks/codeql-$lang-lib/Customizations.qll
            done

            # Rebuild cache
            rm -r codeql/qlpacks/codeql-$lang/.cache
            codeql/codeql query compile --search-path codeql --threads 0 codeql/qlpacks/codeql-$lang
          done

          tar -czf codeql-bundle.tar.gz codeql
          rm -r codeql

          gh release create ${CODEQL_BUNDLE}-$(git rev-parse --short $GITHUB_SHA) codeql-bundle.tar.gz
